<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Heroes 3 - damage calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 18px;
        }

        h1 {
            text-align: center;
            margin-bottom: 8px;
        }

        .battle-wrapper {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 12px;
            flex-direction: column;
            align-items: center;
        }

        .unit-area {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
            gap: 20px;
        }

        .param-col {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin: 0 6px;
        }

        .unit-box {
            border: 2px solid #333;
            width: 240px;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 8px;
            box-sizing: border-box;
        }

        .unit-box select {
            width: 100%;
        }

        .unit-stats {
            margin-top: 8px;
            font-size: 13px;
            line-height: 1.2;
            text-align: left;
            width: 100%;
        }

        .number-input {
            width: 45px;
            padding: 2px 4px;
            box-sizing: border-box;
        }

        .number-input[data-id="2"] {
            width: 85px;
        }

        .param-line {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            justify-content: flex-end;
        }

        .radio-group-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .radio-line {
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: flex-end;
        }

        #copy-btn, #reset-btn {
            padding: 6px 12px;
            border: 1px solid #333;
            background: #eee;
            cursor: pointer;
        }

        #copy-btn:hover, #reset-btn:hover {
            background: #ddd;
        }

        label.small {
            font-size: 12px;
            color: #333;
        }

        .param-group {
            border-top: 1px solid #ccc;
            padding-top: 8px;
            margin-top: 8px;
        }

        .disabled-param {
            opacity: 0.5;
            pointer-events: none;
        }

        #rest-result-and-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            margin-top: 35px;
        }

        #rest-result {
            font-size: 2em;
            font-weight: bold;
            min-height: 0.3em;
        }

        #defender-params .param-line,
        #defender-params .radio-line {
            justify-content: flex-start;
        }

        #defender-params .param-line > label,
        #defender-params .radio-line > label {
            order: 2;
        }

        #defender-params .param-line > input,
        #defender-params .param-line > select,
        #defender-params .radio-line > input {
            order: 1;
        }

        input[type="checkbox"] {
            transform: scale(1.4);
            margin-right: 5px;
            margin-top: 7px;
            margin-bottom: 7px;
        }

        input[type="radio"] {
            transform: scale(1.4);
            margin-right: 5px;
        }

        [data-id="2"] {
            margin-bottom: 7px;
        }

        [data-id="4"],
        [data-id="5"],
        [data-id="23"] {
            font-size: 14px;
            padding: 2px 4px;
            height: 24px;
            margin-bottom: 7px;
        }

        /* SVG */
        .arrow-box {
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.0);
        }
        .right-arrow {
            width: 60px;
            height: 40px;
        }
        .right-arrow path {
            stroke: #333;
            stroke-width: 2;
        }
    </style>
</head>
<body>
<div class="battle-wrapper">
    <h2>Heroes 3 - damage calculator</h2>
    <div class="unit-area">
        <div style="display:flex; flex-direction: column; align-items:center; gap: 10px;">
            <div class="unit-box">
                <select id="attacker-castle-select" style="width: 100%; margin-bottom: 5px;"></select>
                <select id="attacker-select"></select>
                <div class="unit-stats" id="attacker-stats"></div>
            </div>
            <div class="param-col" id="attacker-params"></div>
        </div>

        <div id="rest-result-and-controls">
            <span id="rest-result"></span>
            <div class="arrow-box">
                <svg class="right-arrow" viewBox="5 7 18 9" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 12L20 12M20 12L14 8M20 12L14 16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <button id="reset-btn">reset parameters</button>
        </div>

        <div style="display:flex; flex-direction: column; align-items:center; gap: 10px;">
            <div class="unit-box">
                <select id="defender-castle-select" style="width: 100%; margin-bottom: 5px;"></select>
                <select id="defender-select"></select>
                <div class="unit-stats" id="defender-stats"></div>
            </div>
            <div class="param-col" id="defender-params"></div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script>
    const creaturesCSV = `Unit_name,Castle,Level,Attack,Defence,Minimum Damage,Maximum Damage,Health,Speed,Growth,AI_Value,Gold,Additional_item,Special_abilities
Pikeman,Castle,1,4,5,1,3,10,4,14,80,60,0,Immunetojousting
Halberdier,Castle,1+,6,5,2,3,10,5,14,115,75,0,Immunetojousting
Archer,Castle,2,6,3,2,3,10,4,9,126,100,0,Ranged(12shots)
Marksman,Castle,2+,6,3,2,3,10,6,9,184,150,0,"Ranged(24shots),Doubleattack"
Griffin,Castle,3,8,8,3,6,25,6,7,351,200,0,"Flying,Tworetaliations"
Royal Griffin,Castle,3+,9,9,3,6,25,9,7,448,240,0,"Flying,Unlimitedretaliations"
Swordsman,Castle,4,10,12,6,9,35,5,4,445,300,0,-
Crusader,Castle,4+,12,12,7,10,35,6,4,558,400,0,Doubleattack
Monk,Castle,5,12,7,10,12,30,5,3,485,400,0,Ranged(12shots)
Zealot,Castle,5+,12,10,10,12,30,7,3,750,450,0,"Ranged(24shots),Nomeleepenalty"
Cavalier,Castle,6,15,15,15,25,100,7,2,1946,1000,0,Jousting
Champion,Castle,6+,16,16,20,25,100,9,2,2100,1200,0,Jousting
Angel,Castle,7,20,20,50,50,200,12,1,5019,3000,"Gem,1","Flying,HatesDevils,Morale+1"
Archangel,Castle,7+,30,30,50,50,250,18,1,8776,5000,"Gem,3","Flying,HatesDevils,Resurrection,Morale+1"
Centaur,Rampart,1,5,3,2,3,8,6,14,100,70,0,-
Centaur Captain,Rampart,1+,6,3,2,3,10,8,14,138,90,0,-
Dwarf,Rampart,2,6,7,2,4,20,3,8,138,120,0,Resistance+20%
Battle Dwarf,Rampart,2+,7,7,2,4,20,5,8,209,150,0,Resistance+40%
Wood Elf,Rampart,3,9,5,3,5,15,6,7,234,200,0,Ranged(24shots)
Grand Elf,Rampart,3+,9,5,3,5,15,7,7,331,225,0,"Ranged(24shots),Doubleattack"
Pegasus,Rampart,4,9,8,5,9,30,8,5,518,250,0,"Flying,Magicdamper"
Silver Pegasus,Rampart,4+,9,10,5,9,30,12,5,532,275,0,"Flying,Magicdamper"
Dendroid Guard,Rampart,5,9,12,10,14,55,3,3,517,350,0,Binding
Dendroid Soldier,Rampart,5+,9,12,10,14,65,4,3,803,425,0,Binding
Unicorn,Rampart,6,15,14,18,22,90,7,2,1806,850,0,"Blind,AuraofResistance+20%"
War Unicorn,Rampart,6+,15,14,18,22,110,9,2,2030,950,0,"Blind,AuraofResistance+20%"
Green Dragon,Rampart,7,18,18,40,50,180,10,1,4872,2400,"Crystal,1","Flying,Breathattack,Resistlvl1–3spells"
Gold Dragon,Rampart,7+,27,27,40,50,250,16,1,8613,4000,"Crystal,2","Flying,Breathattack,Resistlvl1–4spells"
Gremlin,Tower,1,3,3,1,2,4,4,16,44,30,0,-
Master Gremlin,Tower,1+,4,4,1,2,4,5,16,66,40,0,Ranged(8shots)
Stone Gargoyle,Tower,2,6,6,2,3,16,6,9,165,130,0,"Unliving,Flying"
Obsidian Gargoyle,Tower,2+,7,7,2,3,16,9,9,201,160,0,"Unliving,Flying"
Stone Golem,Tower,3,7,10,4,5,30,3,6,250,150,0,"Unliving,SpellDamageResistance+50%"
Iron Golem,Tower,3+,9,10,4,5,35,5,6,412,200,0,"Unliving,SpellDamageResistance+75%"
Mage,Tower,4,11,8,7,9,25,5,4,570,350,0,"Ranged(24shots),Nomeleepenalty,Spellscost-2sp"
Arch Mage,Tower,4+,12,9,7,9,30,7,4,680,450,0,"Ranged(24shots),Nomeleepenalty,Noobstaclepenalty,Spellscost-2sp"
Genie,Tower,5,12,12,13,16,40,7,3,884,550,0,"Flying,HatesEfreets"
Master Genie,Tower,5+,12,12,13,16,40,11,3,942,600,0,"Flying,Spellcaster,HatesEfreets"
Naga,Tower,6,16,13,20,20,110,5,2,2016,1100,0,Noenemyretaliation
Naga Queen,Tower,6+,16,13,30,30,110,7,2,2840,1600,0,Noenemyretaliation
Giant,Tower,7,19,16,40,60,150,7,1,3718,2000,"Gem,1",ImmunitytoMind
Titan,Tower,7+,24,24,40,60,300,11,1,7500,5000,"Gem,2","Ranged(24shots),Nomeleepenalty,ImmunitytoMind,HatesBlackDragons"
Imp,Inferno,1,2,3,1,2,4,5,15,50,50,0,-
Familiar,Inferno,1+,4,4,1,2,4,7,15,60,60,0,Magicchannel
Gog,Inferno,2,6,4,2,4,13,4,8,159,125,0,Ranged(12shots)
Magog,Inferno,2+,7,4,2,4,13,6,8,240,175,0,"Ranged(24shots),Fireballattack"
Hell Hound,Inferno,3,10,6,2,7,25,7,5,357,200,0,-
Cerberus,Inferno,3+,10,8,2,7,25,8,5,392,250,0,"Noenemyretaliation,3-headedattack"
Demon,Inferno,4,10,10,7,9,35,5,4,445,250,0,-
Horned Demon,Inferno,4+,10,10,7,9,40,6,4,480,270,0,-
Pit Fiend,Inferno,5,13,13,13,17,45,6,3,765,500,0,-
Pit Lord,Inferno,5+,13,13,13,17,45,7,3,1224,700,0,Summondemons
Efreet,Inferno,6,16,12,16,24,90,9,2,1670,900,0,"Flying,Fireimmunity"
Efreet Sultan,Inferno,6+,16,14,16,24,90,13,2,1848,1100,0,"Flying,Fireshield,Fireimmunity,HatesGenies"
Devil,Inferno,7,19,21,30,40,160,11,1,5101,2700,"Mercury,1","Teleporting,Noenemyretaliation,Luck-1,HatesAngels"
Arch Devil,Inferno,7+,26,28,30,40,200,17,1,7115,4500,"Mercury,2","Teleporting,Noenemyretaliation,Luck-1,HatesAngels"
Skeleton,Necropolis,1,5,4,1,3,6,4,12,60,60,0,Undead
Skeleton Warrior,Necropolis,1+,6,6,1,3,6,5,12,85,70,0,Undead
Walking Dead,Necropolis,2,5,5,2,3,15,3,8,98,100,0,Undead
Zombie,Necropolis,2+,5,5,2,3,20,4,8,128,125,0,"Undead,Disease"
Wight,Necropolis,3,7,7,3,5,18,5,7,252,200,0,"Undead,Flying,Regeneration"
Wraith,Necropolis,3+,7,7,3,5,18,7,7,315,230,0,"Undead,Flying,Regeneration,Manadrain"
Vampire,Necropolis,4,10,9,5,8,30,6,4,555,360,0,"Undead,Flying,Noretaliation"
Vampire Lord,Necropolis,4+,10,10,5,8,40,9,4,783,500,0,"Undead,Flying,Noretaliation,Lifedrain"
Lich,Necropolis,5,13,10,11,13,30,6,3,848,550,0,"Ranged(12shots),Undead,Deathcloud"
Power Lich,Necropolis,5+,13,10,11,15,40,7,3,1079,600,0,"Ranged(24shots),Undead,Deathcloud"
Black Knight,Necropolis,6,16,16,15,30,120,7,2,2084,1200,0,"Undead,Curse"
Dread Knight,Necropolis,6+,18,18,15,30,120,9,2,2382,1500,0,"Undead,Curse,Deathblow"
Bone Dragon,Necropolis,7,17,15,25,50,150,9,1,3388,1800,0,"Dragon,Undead,Flying,Morale-1"
Ghost Dragon,Necropolis,7+,19,17,25,50,200,14,1,4696,3000,"Mercury,1","Dragon,Undead,Flying,Morale-1,Aging"
Troglodyte,Dungeon,1,4,3,1,3,5,4,14,59,50,0,ImmunetoBlinding
Infernal Troglodyte,Dungeon,1+,5,4,1,3,6,5,14,84,65,0,ImmunetoBlinding
Harpy,Dungeon,2,6,5,1,4,14,6,8,154,130,0,"Flying,Strikeandreturn"
Harpy Hag,Dungeon,2+,6,6,1,4,14,9,8,238,170,0,"Flying,Strikeandreturn,Noenemyretaliation"
Beholder,Dungeon,3,9,7,3,5,22,5,7,336,250,0,"Ranged(12shots),Nomeleepenalty"
Evil Eye,Dungeon,3+,10,8,3,5,22,7,7,367,280,0,"Ranged(24shots),Nomeleepenalty"
Medusa,Dungeon,4,9,9,6,8,25,5,4,517,300,0,"Ranged(4shots),Nomeleepenalty,Petrify"
Medusa Queen,Dungeon,4+,10,10,6,8,30,6,4,577,330,0,"Ranged(8shots),Nomeleepenalty,Petrify"
Minotaur,Dungeon,5,14,12,12,20,50,6,3,835,500,0,Positivemorale
Minotaur King,Dungeon,5+,15,15,12,20,50,8,3,1068,575,0,Positivemorale
Manticore,Dungeon,6,15,13,14,20,80,7,2,1547,850,0,Flying
Scorpicore,Dungeon,6+,16,14,14,20,80,11,2,1589,1050,0,"Flying,Paralyze"
Red Dragon,Dungeon,7,19,19,40,50,180,11,1,4702,2500,"Sulfur,1","Dragon,Flying,Breathattack,Resistlvl1-3spells"
Black Dragon,Dungeon,7+,25,25,40,50,300,15,1,8721,4000,"Sulfur,2","Dragon,Flying,Breathattack,Resistallspells,HatesTitans"
Goblin,Stronghold,1,4,2,1,2,5,5,15,60,40,0,-
Hobgoblin,Stronghold,1+,5,3,1,2,5,7,15,78,50,0,-
Wolf Rider,Stronghold,2,7,5,2,4,10,6,9,130,100,0,-
Wolf Raider,Stronghold,2+,8,5,3,4,10,8,9,203,140,0,Doubleattack
Orc,Stronghold,3,8,4,2,5,15,4,7,192,150,0,Ranged(12shots)
Orc Chieftain,Stronghold,3+,8,4,2,5,20,5,7,240,165,0,Ranged(24shots)
Ogre,Stronghold,4,13,7,6,12,40,4,4,416,300,0,-
Ogre Mage,Stronghold,4+,13,7,6,12,60,5,4,672,400,0,CastBloodlustx3
Roc,Stronghold,5,13,11,11,15,60,7,3,1027,600,0,Flying
Thunderbird,Stronghold,5+,13,11,11,15,60,11,3,1106,700,0,"Flying,Lightningstrike"
Cyclops,Stronghold,6,15,12,16,20,70,6,2,1266,750,0,"Ranged(16shots),Canattacksiegewalls"
Cyclops King,Stronghold,6+,17,13,16,20,70,8,2,1443,1100,0,"Ranged(24shots),Canattacksiegewalls"
Behemoth,Stronghold,7,17,17,30,50,160,6,1,3162,1500,0,Defense-40%toenemytarget
Ancient Behemoth,Stronghold,7+,19,19,30,50,300,9,1,6168,3000,"Crystal,1",Defense-80%toenemytarget
Gnoll,Fortress,1,3,5,2,3,6,4,12,56,50,0,-
Gnoll Marauder,Fortress,1+,4,6,2,3,6,5,12,90,70,0,-
Lizardman,Fortress,2,5,6,2,3,14,4,9,126,110,0,Ranged(12shots)
Lizard Warrior,Fortress,2+,6,8,2,5,15,5,9,156,140,0,Ranged(24shots)
Serpent Fly,Fortress,3,7,9,2,5,20,9,8,268,220,0,"Flying,Dispel"
Dragon Fly,Fortress,3+,8,10,2,5,20,13,8,312,240,0,"Flying,Dispel,Weakness"
Basilisk,Fortress,4,11,11,6,10,35,5,4,552,325,0,Petrify
Greater Basilisk,Fortress,4+,12,12,6,10,40,7,4,714,400,0,Petrify
Gorgon,Fortress,5,10,14,12,16,70,5,3,890,525,0,-
Mighty Gorgon,Fortress,5+,11,16,12,16,70,6,3,1028,600,0,Deathstare10%chance/unit
Wyvern,Fortress,6,14,14,14,18,70,7,2,1350,800,0,Flying
Wyvern Monarch,Fortress,6+,14,14,18,22,70,11,2,1518,1100,0,"Flying,Poison"
Hydra,Fortress,7,16,18,25,45,175,5,1,4120,2200,0,"Noenemyretaliation,Attackalladjacentenemies"
Chaos Hydra,Fortress,7+,18,20,25,45,250,7,1,5931,3500,"Sulfur,1","Noenemyretaliation,Attackalladjacentenemies"
Pixie,Conflux,1,2,2,1,2,3,7,20,55,25,0,Flying
Sprite,Conflux,1+,2,2,1,3,3,9,20,95,30,0,"Flying,Noenemyretaliation"
Air Elemental,Conflux,2,9,9,2,8,25,7,6,356,250,0,"Elemental,Lightningvulnerability,ImmunetoMeteorShower"
Storm Elemental,Conflux,2+,9,9,2,8,25,8,6,486,275,0,"Ranged(24shots),Elemental,Lightningvulnerability,ImmunetoMeteorShower,CastsProtectionfromAir"
Water Elemental,Conflux,3,8,10,3,7,30,5,6,315,300,0,"Elemental,VulnerabletoFireball,InfernoandArmageddon,Iceimmunity"
Ice Elemental,Conflux,3+*,8,10,3,7,30,6,6,380,375,0,"Ranged(24shots),Elemental,VulnerabletoFireball,InfernoandArmageddon,Iceimmunity,CastsProtectionfromWater"
Fire Elemental,Conflux,4,10,8,4,6,35,6,5,345,350,0,"Elemental,Icevulnerability,Fireimmunity"
Energy Elemental,Conflux,4+*,12,8,4,6,35,8,5,470,400,0,"Elemental,Flying,Icevulnerability,Fireimmunity,CastsProtectionfromFire"
Earth Elemental,Conflux,5,10,10,4,8,40,4,4,330,400,0,"Elemental,MeteorShowervulnerability,LightningandArmageddonimmunity"
Magma Elemental,Conflux,5+*,11,11,6,10,40,6,4,490,500,0,"Elemental,MeteorShowervulnerability,LightningandArmageddonimmunity,CastsProtectionfromEarth"
Psychic Elemental,Conflux,6,15,13,10,20,75,7,2,1669,750,0,"Elemental,Noenemyretaliation,Attacksadjacenthexes"
Magic Elemental,Conflux,6+,15,13,15,25,80,9,2,2012,800,0,"Elemental,Noenemyretaliation,Attacksadjacenthexes,Spellimmunity"
Firebird,Conflux,7,18,18,30,40,150,15,2,4547,1500,0,"Flying,Breathattack,Fireimmunity"
Phoenix,Conflux,7+,21,18,30,40,200,21,2,6721,2000,"Mercury,1","Flying,Breathattack,Fireimmunity,Rebirth"
Peasant,Neutral,1,1,1,1,1,1,3,25,15,10,0,-
Halfling,Neutral,1,4,2,1,3,4,5,15,75,40,0,"Ranged(24shots),PositiveLuck"
Boar,Neutral,2,6,5,2,3,15,6,8,145,150,0,-
Rogue,Neutral,2,8,3,2,4,10,6,8,135,100,0,Spying
Mummy,Neutral,3,7,7,3,5,30,5,7,270,300,0,"Undead,Curse"
Nomad,Neutral,3,9,8,2,6,30,7,7,345,200,0,Sandwalker
Sharpshooter,Neutral,4,12,10,8,10,15,9,4,585,400,0,"Ranged(32shots),Norangeandobstaclepenalty"
Troll,Neutral,5,14,7,10,15,40,7,3,1024,500,0,Regeneration
Gold Golem,Neutral,5,11,12,8,10,50,5,3,600,500,0,"Unliving,SpellDamageResistance+85%"
Diamond Golem,Neutral,6,13,12,10,14,60,5,2,775,750,0,"Unliving,SpellDamageResistance+95%"
Enchanter,Neutral,6,17,12,14,14,30,9,2,1210,750,0,"Ranged(32shots),Nomeleeandobstaclepenalty,Spellcaster"
Faerie Dragon,Neutral,7,20,20,20,30,500,15,1,19580,10000,"Gem,8","Dragon,Flying,Spellcaster,MagicMirror"
Rust Dragon,Neutral,7,30,30,50,50,750,17,1,26433,15000,"Sulfur,14","Dragon,Flying,Breath,Acidbreath"
Crystal Dragon,Neutral,7,40,40,60,75,800,16,1,39338,20000,"Crystal,10","Dragon,Crystalgeneration,Resistance+20%,Unliving"
Azure Dragon,Neutral,7,50,50,70,80,1000,19,1,78845,30000,"Mercury,20","Dragon,Flying,Breath,Fear,Resistlvl1–3spells,ResistFear"
`;
    let creatures = [];
    let debounceTimer;
    const levelMap = {'-': 'None', 'basic': 'BASIC', 'advanced': 'ADVANCED', 'expert': 'EXPERT'};
    const numerNazwaMap = {
        2: "number of units", 3: "attack", 4: "attack skill", 5: "archery skill", 6: "attack specialization", 7: "archery specialization", 8: "hero level", 9: "fortune", 10: "bless", 11: "(at least advanced water magic) bless", 12: "curse", 13: "(at least advanced fire magic) curse", 14: "broken arrow", 15: "melee", 16: "artifact +5% to archery", 17: "artifact +10% to archery", 18: "artifact +15% to archery", 19: "death blow", 20: "jousting bonus", 22: "defence", 23: "defence skill", 24: "defence specialization", 25: "hero level", 26: "shield", 27: "shield (at least advanced earth magic)", 28: "air shield", 29: "air shield (at least advanced air magic)"
    };
    const paramKeys = {
        2: "unit_attacker_amount", 3: "unit_attacker_attack", 4: "hero_attacker_skill_offense_level", 5: "hero_attacker_skill_archery_level", 6: "hero_attacker_specialization_offence", 7: "hero_attacker_specialization_archery", 8: "hero_attacker_level", 9: "fortune", 10: "bless_spell", 11: "bless_spell_with_water_magic_at_least_at_advanced_level", 12: "curse_spell", 13: "curse_spell_with_fire_magic_at_least_at_advanced_level", 14: "shot_with_a_broken_arrow", 15: "ranged_unit_at_melee_attack", 16: "artifact___bow_of_elven_cherrywood___5_percent", 17: "artifact___bowstring_of_the_unicorns_mane___10_percent", 18: "artifact___angel_feather_arrows___15_percent", 19: "deathblow_of_the_dread_knight", 20: "cavalier_and_champion_hex", 22: "unit_defender_defence", 23: "hero_defender_skill_armorer_level", 24: "hero_defender_specialization_armorer", 25: "hero_defender_level", 26: "shield_spell", 27: "shield_spell_with_earth_magic_at_least_at_advanced_level", 28: "air_shield_spell", 29: "air_shield_spell_with_air_magic_at_least_at_advanced_level"
    };

    function setupCastleSelects() {
        const uniqueCastles = ['all castles', ...new Set(creatures.map(c => c.Castle).filter(Boolean).sort())];

        const attackerCastleSelect = $('#attacker-castle-select');
        const defenderCastleSelect = $('#defender-castle-select');

        attackerCastleSelect.empty();
        defenderCastleSelect.empty();

        uniqueCastles.forEach(castle => {
            attackerCastleSelect.append(new Option(castle, castle));
            defenderCastleSelect.append(new Option(castle, castle));
        });

        attackerCastleSelect.on('change', function() {
            fillSelect("#attacker-select", $(this).val());
        });

        defenderCastleSelect.on('change', function() {
            fillSelect("#defender-select", $(this).val());
        });
    }

    function loadCreatures() {
        const parsed = Papa.parse(creaturesCSV.trim(), {header: true, skipEmptyLines: true});
        creatures = parsed.data.filter(r => r.Unit_name && r.Unit_name.trim().length > 0);
        setupCastleSelects();
        fillSelect("#attacker-select");
        fillSelect("#defender-select");
    }

    function fillSelect(selector, castleFilter = 'All Castles') {
        const sel = $(selector);

        const unitsToShow = (castleFilter === 'All Castles' || !castleFilter)
            ? creatures
            : creatures.filter(c => c.Castle === castleFilter);

        sel.empty();
        unitsToShow.forEach(c => sel.append(new Option(c.Unit_name + ' (' + c.Castle + ', ' + c.Level + ')', c.Unit_name)));

        sel.off('change').on('change', function () {
            updateUnitParams(selector);
        });

        sel.trigger('change');
    }

    function showStats(selector) {
        const name = $(selector).val();
        const statsDiv = selector === '#attacker-select' ? $('#attacker-stats') : $('#defender-stats');
        const c = creatures.find(x => x.Unit_name === name);
        if (!c) {
            statsDiv.html(''); return;
        }
        const damageInfo = (c['Maximum Damage'] === c['Minimum Damage']) ? (c['Minimum Damage'] || '') : `${c['Minimum Damage']}-${c['Maximum Damage']}`;
        statsDiv.html(`<div><strong>${c.Unit_name}</strong> (${c.Castle || ''})</div><span>attack: ${c.Attack || ''}</span>, <span>defence: ${c.Defence || ''}</span><br><span>damage: ${damageInfo}</span>, <span>health: ${c.Health || ''}</span>`);
    }

    function createNumberInput(min, max, def, id) {
        const wrapper = $(`<div class="param-line" data-param-id="${id}"><label class="small">${numerNazwaMap[id]}</label></div>`);
        const input = $(`<input type="number" class="number-input" min="${min}" max="${max}" value="${def}" data-id="${id}">`);
        input.on('input', updateParameterStates);
        return wrapper.append(input);
    }

    function createSelect(options, id) {
        const wrapper = $(`<div class="param-line" data-param-id="${id}"><label class="small">${numerNazwaMap[id]}</label></div>`);
        const sel = $('<select></select>').attr('data-id', id);
        options.forEach(opt => sel.append(new Option(opt, opt)));
        sel.on('change', updateParameterStates);
        return wrapper.append(sel);
    }

    function createCheckbox(id) {
        const wrapper = $(`<div class="param-line" data-param-id="${id}"><label class="small" for="cb-${id}">${numerNazwaMap[id]}</label></div>`);
        const checkbox = $(`<input type="checkbox" id="cb-${id}" data-id="${id}">`);
        checkbox.on('change', function() {
            if ($(this).is(':checked')) {
                if (id === 6 || id === 7) $('[data-id="8"]').val(1);
                else if (id === 24) $('[data-id="25"]').val(1);
            }
            updateParameterStates();
        });
        return wrapper.append(checkbox);
    }

    function createRadioGroup(ids, groupName) {
        const wrapper = $('<div class="radio-group-container"></div>');
        ids.forEach((id, index) => {
            const radioId = `radio-${groupName}-${id}`;
            const line = $(`<div class="radio-line" data-param-id="${id}"></div>`);
            const radio = $(`<input type="radio" name="${groupName}" id="${radioId}" data-id="${id}">`);
            if (index === 0) radio.prop('checked', true);
            radio.on('change', updateParameterStates);
            const label = $(`<label for="${radioId}" class="small">${numerNazwaMap[id]}</label>`);
            line.append(label).append(radio);
            wrapper.append(line);
        });
        return wrapper;
    }

    function initParams() {

        $('#attacker-params').empty().append(
            $('<div class="param-group"></div>').append(
                createNumberInput(1, 10000, 1, 2),
                createNumberInput(1, 200, 1, 3)
            ),
            $('<div class="param-group"></div>').append(
                createSelect(['-', 'basic', 'advanced', 'expert'], 4),
                createSelect(['-', 'basic', 'advanced', 'expert'], 5),
                createCheckbox(6),
                createCheckbox(7),
                createNumberInput(-1, 100, -1, 8)
            ),
            $('<div class="param-group"></div>').append(
                createCheckbox(9)
            ),
            $('<div class="param-group"></div>').append(
                createRadioGroup([10, 11, 12, 13], 'spell-choice')
            ),
            $('<div class="param-group"></div>').append(
                createCheckbox(14),
                createCheckbox(15),
                createCheckbox(16),
                createCheckbox(17),
                createCheckbox(18)
            ),
            $('<div class="param-group"></div>').append(
                createCheckbox(19),
                createNumberInput(0, 18, 0, 20)
            )
        );

        $('#defender-params').empty().append(
            $('<div class="param-group"></div>').append($('<div class="param-line" style="height: 22px;"></div>'), createNumberInput(1, 200, 1, 22)),
            $('<div class="param-group"></div>').append(createSelect(['-', 'basic', 'advanced', 'expert'], 23), createCheckbox(24), createNumberInput(-1, 100, -1, 25)),
            $('<div class="param-group"></div>').append(createCheckbox(26), createCheckbox(27), createCheckbox(28), createCheckbox(29))
        );
    }

    function updateUnitParams(selector) {
        const name = $(selector).val();
        const unit = creatures.find(x => x.Unit_name === name);
        if (unit) {
            if (selector === '#attacker-select') {
                $(`[data-id='3']`).val(unit.Attack);
            } else if (selector === '#defender-select') {
                $(`[data-id='22']`).val(unit.Defence);
            }
        }
        showStats(selector);
        updateParameterStates();
    }

    function updateUnitSpecificParams() {
        const attackerName = $('#attacker-select').val();
        const attackerUnit = creatures.find(u => u.Unit_name === attackerName);
        if (!attackerUnit) return;

        const abilities = attackerUnit.Special_abilities || '';
        const isRanged = abilities.includes('Ranged');

        const artifactIds = [16, 17, 18];
        const rangedParams = [5, 14, 15, 16, 17, 18, 28, 29];
        const meleeParams = [26, 27];

        const archerySkillSelected = $('[data-id="5"]').length ? $('[data-id="5"]').val() !== '-' : false;

        if (isRanged) {
            rangedParams.forEach(id => {
                if (artifactIds.includes(id)) return;
                $(`[data-param-id='${id}']`).removeClass('disabled-param');
            });

            artifactIds.forEach(id => {
                if (archerySkillSelected) {
                    $(`[data-param-id='${id}']`).removeClass('disabled-param');
                } else {
                    $(`[data-param-id='${id}']`).addClass('disabled-param');
                    const el = $(`[data-id='${id}']`);
                    if (el.is('select')) el.val('-');
                    if (el.is('input[type=checkbox]')) el.prop('checked', false);
                }
            });
            meleeParams.forEach(id => {
                $(`[data-param-id='${id}']`).addClass('disabled-param');
                $(`[data-id='${id}']`).prop('checked', false);
            });
            const specAttack = $('[data-id="6"]');
            if (specAttack.is(':checked')) specAttack.prop('checked', false);
            $(`[data-param-id="6"]`).addClass('disabled-param');
        } else {
            rangedParams.forEach(id => {
                $(`[data-param-id='${id}']`).addClass('disabled-param');
                const el = $(`[data-id='${id}']`);
                if (el.is('select')) el.val('-');
                if (el.is('input[type=checkbox]')) el.prop('checked', false);
            });
            meleeParams.forEach(id => $(`[data-param-id='${id}']`).removeClass('disabled-param'));

            const specArchery = $('[data-id="7"]');
            if (specArchery.is(':checked')) specArchery.prop('checked', false);
            $(`[data-param-id="7"]`).addClass('disabled-param');
        }

        const meleeModeChecked = $('[data-id="15"]').is(':checked');
        if (isRanged && !meleeModeChecked) {
            $(`[data-param-id='4']`).addClass('disabled-param');
            $('[data-id="4"]').val('-');
        } else {
            $(`[data-param-id='4']`).removeClass('disabled-param');
        }

        if (isRanged && meleeModeChecked) {
            $(`[data-param-id='5']`).addClass('disabled-param');
            $('[data-id="5"]').val('-'); // cleanup
            $(`[data-param-id='28']`).addClass('disabled-param').prop('checked', false);
            $(`[data-param-id='29']`).addClass('disabled-param').prop('checked', false);
            meleeParams.forEach(id => $(`[data-param-id='${id}']`).removeClass('disabled-param'));
        }

        const isDreadKnight = attackerName === 'Dread Knight';
        const isCavalierOrChampion = attackerName === 'Cavalier' || attackerName === 'Champion';

        $(`[data-param-id='19']`).toggleClass('disabled-param', !isDreadKnight);
        if (!isDreadKnight) $('[data-id="19"]').prop('checked', false);

        $(`[data-param-id='20']`).toggleClass('disabled-param', !isCavalierOrChampion);
        if (!isCavalierOrChampion) $('[data-id="20"]').val(0);
    }

    function updateParameterStates() {
        const offenseSkillSelected  = $('[data-id="4"]').val() !== '-';
        const archerySkillSelected  = $('[data-id="5"]').val() !== '-';
        const armorerSkillSelected  = $('[data-id="23"]').val() !== '-';

        const specAttack = $('[data-id="6"]');
        const specArchery = $('[data-id="7"]');
        const specArmorer = $('[data-id="24"]');

        $(`[data-param-id='6']`).toggleClass('disabled-param', !offenseSkillSelected);
        if (!offenseSkillSelected) {
            specAttack.prop('checked', false);
        }

        $(`[data-param-id='7']`).toggleClass('disabled-param', !archerySkillSelected);
        if (!archerySkillSelected) {
            specArchery.prop('checked', false);
        }

        [16,17,18].forEach(id => {
            const el = $(`[data-id="${id}"]`);
            $(`[data-param-id="${id}"]`).toggleClass('disabled-param', !archerySkillSelected);
            if (!archerySkillSelected) el.prop('checked', false);
        });

        $(`[data-param-id='24']`).toggleClass('disabled-param', !armorerSkillSelected);
        if (!armorerSkillSelected) {
            specArmorer.prop('checked', false);
        }

        const attackerLevelInput = $('[data-id="8"]');
        if (specAttack.is(':checked') || specArchery.is(':checked')) {
            $(`[data-param-id='8']`).removeClass('disabled-param');
            const preservedLevel = attackerLevelInput.data('preserved-level');
            if (preservedLevel) {
                attackerLevelInput.val(preservedLevel);
                attackerLevelInput.removeData('preserved-level');
            } else if (attackerLevelInput.val() == -1) {
                attackerLevelInput.val(1);
            }
        } else {
            const currentLevel = attackerLevelInput.val();
            if (currentLevel != -1) {
                attackerLevelInput.data('preserved-level', currentLevel);
            }
            $(`[data-param-id='8']`).addClass('disabled-param');
            attackerLevelInput.val(-1);
        }

        const defenderLevelInput = $('[data-id="25"]');
        if (specArmorer.is(':checked')) {
            $(`[data-param-id='25']`).removeClass('disabled-param');
            const preservedLevel = defenderLevelInput.data('preserved-level');
            if (preservedLevel) {
                defenderLevelInput.val(preservedLevel);
                defenderLevelInput.removeData('preserved-level');
            } else if (defenderLevelInput.val() == -1) {
                defenderLevelInput.val(1);
            }
        } else {
            const currentLevel = defenderLevelInput.val();
            if (currentLevel != -1) {
                defenderLevelInput.data('preserved-level', currentLevel);
            }
            $(`[data-param-id='25']`).addClass('disabled-param');
            defenderLevelInput.val(-1);
        }

        const shield = $('[data-id="26"]');
        const shieldEarth = $('[data-id="27"]');
        $(`[data-param-id='27']`).toggleClass('disabled-param', shield.is(':checked'));
        if (shield.is(':checked')) shieldEarth.prop('checked', false);
        $(`[data-param-id='26']`).toggleClass('disabled-param', shieldEarth.is(':checked'));
        if (shieldEarth.is(':checked')) shield.prop('checked', false);

        const airShield = $('[data-id="28"]');
        const airShieldAir = $('[data-id="29"]');
        $(`[data-param-id='29']`).toggleClass('disabled-param', airShield.is(':checked'));
        if (airShield.is(':checked')) airShieldAir.prop('checked', false);
        $(`[data-param-id='28']`).toggleClass('disabled-param', airShieldAir.is(':checked'));
        if (airShieldAir.is(':checked')) airShield.prop('checked', false);

        const brokenArrow = $('[data-id="14"]');
        const meleeMode = $('[data-id="15"]');
        $(`[data-param-id='15']`).toggleClass('disabled-param', brokenArrow.is(':checked'));
        if (brokenArrow.is(':checked')) meleeMode.prop('checked', false);
        $(`[data-param-id='14']`).toggleClass('disabled-param', meleeMode.is(':checked'));
        if (meleeMode.is(':checked')) brokenArrow.prop('checked', false);

        updateUnitSpecificParams();
        debouncedUpdateResult();
    }

    function resetParams() {
        $('#attacker-params select, #defender-params select').val('-');
        $('#attacker-params input[type=checkbox], #defender-params input[type=checkbox]').prop('checked', false);
        $('[data-id="10"]').prop('checked', true);

        $('#attacker-params input[type=number], #defender-params input[type=number]').each(function() {
            const id = $(this).data('id');
            if (id === 8 || id === 25) $(this).val(-1);
            else if (id === 20) $(this).val(0);
            else $(this).val(1);
        });

        const attackerUnit = creatures.find(u => u.Unit_name === $('#attacker-select').val());
        const defenderUnit = creatures.find(u => u.Unit_name === $('#defender-select').val());
        if (attackerUnit) $(`[data-id='3']`).val(attackerUnit.Attack);
        if (defenderUnit) $(`[data-id='22']`).val(defenderUnit.Defence);

        updateParameterStates();
    }

    function debouncedUpdateResult() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updateResult, 150);
    }

    async function updateResult() {
        const params = { unit_attacker_name: $('#attacker-select').val() || '', unit_defender_name: $('#defender-select').val() || '' };
        for (const i in paramKeys) {
            const el = $(`[data-id='${i}']`);
            if (!el.length) continue;
            const isDisabled = el.closest('.param-line, .radio-line').hasClass('disabled-param');
            let value;
            if (isDisabled) {
                if (el.is('input[type=number]')) value = -1;
                else if (el.is('input[type=checkbox], input[type=radio]')) value = false;
                else value = null;
            } else if (el.is('select')) {
                const val = el.val();
                if (['4', '5', '23'].includes(i)) value = levelMap[val] === 'None' ? null : levelMap[val];
                else value = val;
            } else if (el.is('input[type=checkbox], input[type=radio]')) {
                value = el.is(':checked');
            } else if (el.is('input[type=number]')) {
                const v = el.val();
                value = v !== '' ? parseInt(v, 10) : null;
            }
            params[paramKeys[i]] = value;
        }

        try {
            const response = await fetch('http://127.0.0.1:5000/calculate-damage', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(params),
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const restResult = await response.json();
            $('#rest-result').text(restResult).css('color', 'green');
        } catch (error) {
            $('#rest-result').text('Error').css('color', 'red');
        }
    }

    $(document).ready(function () {
        initParams();
        loadCreatures();
        $('#reset-btn').on('click', resetParams);
        resetParams();
    });
</script>
</body>
</html>
